<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>S‑COIN Redemption — Senheng Theme (Strict Square Thumbs)</title>
  <meta name="description" content="Browse and redeem S-COIN rewards at Senheng">
  <meta name="color-scheme" content="light dark">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&display=swap" rel="stylesheet"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    :root{
      --brand:#E60012; --brand-500:#ff1a2b; --brand-050:#fff3f4;
      --bg:#fafafa; --panel:rgba(255,255,255,.96); --panel-2:#fff; --panel-border:#e6e8eb;
      --text:#111318; --muted:#5a5f69; --on-strong:#fff; --coin:#f7b500; --danger:#f14d61;
      --radius:20px; --glass:blur(12px) saturate(110%); --shadow:0 10px 30px rgba(0,0,0,.08), 0 2px 8px rgba(0,0,0,.06);
      --frame-size:260px; /* change here if you want bigger/smaller thumbnails */
      --success: #10b981;
    }
    :root[data-theme="dark"]{
      --bg:#0b0c0e; --panel:rgba(20,22,26,.84); --panel-2:#171a20; --panel-border:#2a2e36;
      --text:#edf0f5; --muted:#aeb5c0; --on-strong:#fff; --shadow:0 16px 42px rgba(0,0,0,.45), 0 4px 12px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:'Montserrat',system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,sans-serif;
      color:var(--text);
      background:radial-gradient(1200px 600px at -10% -20%,var(--brand-050) 0%,transparent 55%),
                radial-gradient(900px 600px at 110% 10%,#fff1f2 0%,transparent 55%),
                linear-gradient(180deg,#fff 0,#fff 240px,transparent 240px),var(--bg);
      background-attachment:fixed;
      transition: background 0.3s ease;
    }
    
    /* Improved header and navigation */
    header{position:sticky;top:0;z-index:50;backdrop-filter:blur(8px);transition: backdrop-filter 0.3s ease;}
    .brand-bar{height:8px;background:linear-gradient(90deg,var(--brand) 0 40%,var(--brand-500) 40% 100%)}
    .hero{
      max-width:1200px;margin:0 auto;padding:1.1rem 1rem .9rem;text-align:center;
      background:linear-gradient(180deg,rgba(255,255,255,.95),rgba(255,255,255,.78));
      border-bottom:1px solid var(--panel-border);
      transition: background 0.3s ease;
    }
    [data-theme="dark"] .hero{background:linear-gradient(180deg,rgba(20,22,26,.92),rgba(20,22,26,.72))}
    .title{
      display:flex;align-items:center;justify-content:center;gap:.65rem;
      font-weight:800;letter-spacing:.3px;font-size:clamp(1.6rem,3.5vw,2.5rem);color:var(--brand)
    }
    .title .logo{
      width:110px;height:22px;display:inline-grid;place-items:center;border-radius:6px;
      background:var(--brand);color:#fff;font-weight:900;letter-spacing:.5px;font-size:.86rem
    }
    .tagline{color:var(--muted);margin:.25rem 0 0;font-size: clamp(0.9rem, 2vw, 1.1rem);}

    /* Enhanced toolbar with better mobile layout */
    .toolbar{
      display:flex;flex-wrap:wrap;gap:.6rem .7rem;align-items:center;justify-content:center;
      max-width:1200px;margin:0 auto;padding:.9rem 1rem 1rem;
      transition: all 0.3s ease;
    }
    .tool{
      display:inline-flex;align-items:center;gap:.55rem;background:var(--panel);
      backdrop-filter:var(--glass);border:1px solid var(--panel-border);border-radius:999px;
      box-shadow:var(--shadow);padding:.55rem .8rem;transition: all 0.2s ease;
    }
    .tool:hover {transform: translateY(-2px); box-shadow: 0 12px 24px rgba(0,0,0,0.1);}
    .tool .label{font-weight:800;font-size:.82rem;color:var(--muted);letter-spacing:.3px}
    .tool input[type="text"],.tool select,.tool input[type="number"]{
      border:none;outline:none;background:transparent;color:inherit;font-size:.98rem;min-width:10ch;
      transition: all 0.2s ease;
    }
    .tool input[type="text"]:focus, .tool select:focus, .tool input[type="number"]:focus {
      box-shadow: 0 0 0 2px var(--brand-500);
      border-radius: 4px;
    }
    .spacer{flex:1 1 100%}

    /* Improved switch with better accessibility */
    .switch{
      --w:54px;--h:30px;--p:3px;position:relative;width:var(--w);height:var(--h);
      border-radius:999px;background:#e7e7ea;border:1px solid var(--panel-border);
      cursor:pointer;display:inline-flex;align-items:center;padding:var(--p);box-shadow:var(--shadow);
      transition: background 0.2s ease;
    }
    .switch[aria-checked="true"]{background:var(--brand)}
    .switch .knob{
      width:calc(var(--h) - var(--p)*2 - 2px);height:calc(var(--h) - var(--p)*2 - 2px);
      background:#fff;border-radius:999px;transform:translateX(0);transition:transform .2s ease
    }
    .switch[aria-checked="true"] .knob{transform:translateX(calc(var(--w) - var(--h)))}

    /* Loading animation */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Improved container and grid */
    .container{max-width:1200px;margin:0 auto;padding:1rem}
    .grid{
      display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:1.25rem;
      transition: all 0.3s ease;
    }

    /* Enhanced card design with better animations */
    .card{
      position:relative;overflow:hidden;border-radius:var(--radius);background:var(--panel);
      border:1px solid var(--panel-border);backdrop-filter:var(--glass);box-shadow:var(--shadow);
      display:flex;flex-direction:column;cursor:pointer;min-height:520px;
      transition:transform .18s ease, box-shadow .18s ease, opacity 0.3s ease;
      opacity: 1;
    }
    .card.hidden {
      display: none;
      opacity: 0;
    }
    .card:hover{
      transform:translateY(-4px);box-shadow:0 22px 52px rgba(230,0,18,.26)
    }
    .brand-badge{
      position:absolute;top:12px;left:12px;background:var(--brand);color:var(--on-strong);
      padding:.42rem .8rem;border-radius:999px;font-size:.83rem;font-weight:900;letter-spacing:1px;z-index:2
    }

    /* STRICT SQUARE FRAMES (never stretch image) */
    .frame{
      position:relative;width:var(--frame-size); /* fixed width */
      aspect-ratio:1/1; /* keep it perfect square */
      margin:1.2rem auto .6rem;background:#fff !important;border:1px solid var(--panel-border);
      border-radius:18px;box-shadow:inset 0 1px 0 rgba(255,255,255,.8), 0 8px 24px rgba(0,0,0,.06);
      overflow:hidden;transition: transform 0.3s ease;
    }
    /* Fallback for browsers without aspect-ratio */
    .frame::before{content:"";display:block;padding-top:100%}
    .frame > img{
      position:absolute;inset:0;margin:auto; /* center */
      max-width:88%;max-height:88%;width:auto;height:auto; /* preserve ratio */
      object-fit:contain;image-rendering:auto;filter:drop-shadow(0 1px 2px rgba(0,0,0,.12));
      transition: transform 0.3s ease;
    }
    .card:hover .frame > img {
      transform: scale(1.05);
    }

    .coin{
      align-self:center;margin:.3rem 0 .8rem;width:min(96%,520px);display:flex;
      align-items:center;justify-content:center;gap:.45rem;font-weight:900;
      font-size:clamp(1.4rem,2.4vw,2rem);color:#2a2200;
      background:linear-gradient(90deg,#ffe49c 70%,#ffd700 100%);border:2px solid #ffe3b3;
      border-radius:28px;box-shadow:0 0 0 4px #fff6a2, 0 12px 28px #f7b50055;padding:.5rem .9rem
    }
    [data-theme="dark"] .coin{color:#1a1400}
    .coin img{width:38px;height:38px}

    .info{padding:0 1rem 1rem;display:flex;flex-direction:column;align-items:center;text-align:center}
    .name{font-size:1.02rem;font-weight:900;color:var(--brand);min-height:2.6rem;line-height:1.3;}
    .model{font-size:.95rem;color:var(--muted);margin-top:.2rem;}

    .tags{display:flex;gap:.5rem;flex-wrap:wrap;justify-content:center;margin:.8rem 0}
    .tag{
      font-weight:900;font-size:.9rem;border-radius:999px;padding:.36rem .9rem;
      border:1px dashed var(--panel-border);background:var(--panel-2);color:var(--text);
      transition: all 0.2s ease;
    }
    .tag.member{background:var(--brand);color:var(--on-strong);border:none}
    .tag.rcp{background:transparent;color:var(--brand);text-decoration:line-through}
    [data-theme="dark"] .tag{background:#1b1e24;border-color:#303640;color:#e9edf3}

    .remark{
      font-size:.92rem;color:var(--on-strong);background:linear-gradient(0deg,#f85b73 0,#f14d61 100%);
      padding:.55rem .7rem;border-radius:8px;max-width:95%;font-weight:700
    }

    /* Improved pagination */
    .pagination{
      display:flex;justify-content:center;align-items:center;gap:.5rem;padding:1.1rem 0 2rem;
      transition: all 0.3s ease;
    }
    .pagination button{
      padding:.62rem 1.1rem;border-radius:10px;border:1px solid var(--panel-border);
      background:var(--panel);cursor:pointer;font-weight:800;color:var(--text);
      transition: all 0.2s ease;
    }
    .pagination button:hover:not([disabled]) {
      background: var(--brand);
      color: var(--on-strong);
      transform: translateY(-2px);
    }
    .pagination button[disabled]{opacity:.55;cursor:not-allowed}

    /* Enhanced modal with better UX */
    .modal{
      position:fixed;inset:0;display:none;place-items:center;z-index:1000;
      background:rgba(0,0,0,.5);backdrop-filter:blur(2px);transition: opacity 0.3s ease;
    }
    .modal.show{display:grid;animation: fadeIn 0.3s ease;}
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    .dialog{
      background:var(--panel);border:1px solid var(--panel-border);border-radius:24px;
      box-shadow:var(--shadow);width:min(95vw,820px);padding:1rem 1rem 1.2rem;position:relative;
      animation: scaleIn 0.3s ease;
    }
    @keyframes scaleIn {
      from { transform: scale(0.9); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }
    .close{
      position:absolute;top:10px;right:12px;width:42px;height:42px;display:grid;
      place-items:center;border-radius:12px;border:1px solid var(--panel-border);
      background:#fff;cursor:pointer;font-size:1.2rem;color:#111;transition: all 0.2s ease;
    }
    .close:hover {
      background: var(--brand);
      color: white;
    }
    .dialog-title{text-align:center;font-weight:900;color:var(--brand);margin:.2rem 0 .6rem}
    .zoom-wrap{
      position:relative;background:#fff;border:1px solid var(--panel-border);border-radius:18px;
      width:min(92vw,760px);height:min(92vh,560px);margin:0 auto;overflow:hidden;touch-action:none
    }
    .zoom-canvas{position:absolute;inset:0;display:grid;place-items:center}
    .zoom-img{max-width:none;max-height:none;width:auto;height:auto;transform-origin:center center;will-change:transform;image-rendering:auto}
    .zoom-controls{position:absolute;right:10px;bottom:10px;display:flex;gap:.4rem}
    .zoom-controls button{
      padding:.5rem .7rem;border-radius:10px;border:1px solid var(--panel-border);
      background:var(--panel);color:var(--text);font-weight:800;cursor:pointer;
      transition: all 0.2s ease;
    }
    .zoom-controls button:hover {
      background: var(--brand);
      color: white;
    }

    /* New elements */
    .results-info {
      text-align: center;
      margin: 1rem 0;
      font-size: 0.9rem;
      color: var(--muted);
      font-weight: 600;
    }
    
    .reset-filters {
      background: var(--brand) !important;
      color: white !important;
      border: none !important;
    }
    
    .skeleton {
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
      background-size: 200% 100%;
      animation: loading 1.5s infinite;
      border-radius: 4px;
    }
    
    @keyframes loading {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }
    
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 12px 20px;
      border-radius: 8px;
      background: var(--success);
      color: white;
      font-weight: 600;
      box-shadow: var(--shadow);
      z-index: 1001;
      transform: translateX(150%);
      transition: transform 0.3s ease;
    }
    
    .notification.show {
      transform: translateX(0);
    }
    
    .mobile-filters {
      display: none;
      width: 100%;
      padding: 0.5rem;
      background: var(--brand);
      color: white;
      border: none;
      border-radius: 10px;
      font-weight: 700;
      margin-bottom: 1rem;
      cursor: pointer;
    }
    
    .filters-collapsed {
      display: none;
    }
    
    /* Responsive improvements */
    @media (max-width:768px){
      :root{--frame-size:210px}
      .dialog{width:min(96vw,820px)}
      .zoom-wrap{height:min(92vh,420px)}
      .card{min-height:460px}
      
      .toolbar {
        flex-direction: column;
        align-items: stretch;
      }
      
      .tool {
        width: 100%;
        justify-content: space-between;
      }
      
      .mobile-filters {
        display: block;
      }
      
      .filters-collapsed .toolbar {
        display: none;
      }
      
      .filters-collapsed .mobile-filters::after {
        content: "Show Filters";
      }
      
      .filters-expanded .mobile-filters::after {
        content: "Hide Filters";
      }
      
      .grid {
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      }
    }
    
    @media (max-width:480px){
      .grid {
        grid-template-columns: 1fr;
      }
      
      .tool input[type="text"], .tool select, .tool input[type="number"] {
        width: 100%;
      }
    }

    .hidden{display:none}
  </style>
</head>
<body>
  <header>
    <div class="brand-bar" aria-hidden="true"></div>
    <div class="hero">
      <div class="title"><span class="logo">SENHENG</span> S‑COIN Redemption</div>
      <p class="tagline">Find your rewards. Claim your joy!</p>
    </div>
    <button class="mobile-filters" aria-expanded="false"></button>
    <div class="toolbar" role="region" aria-label="Filters">
      <div class="tool"><span class="label">Search</span><input id="q" type="text" placeholder="Name or model…" autocomplete="off" inputmode="search" aria-label="Search by name or model"></div>
      <div class="tool"><span class="label">Brand</span><select id="brand"><option value="">All</option></select></div>
      <div class="tool"><span class="label">Sort</span>
        <select id="sort"><option value="">—</option><option value="price-asc">Member Price ↑</option><option value="price-desc">Member Price ↓</option><option value="az">Name A → Z</option><option value="za">Name Z → A</option></select>
      </div>
      <div class="tool"><span class="label">S‑COIN</span><input id="coinMin" type="number" min="0" step="100" placeholder="min" style="width:7ch"><span style="opacity:.6">–</span><input id="coinMax" type="number" min="0" step="100" placeholder="max" style="width:7ch"></div>
      <div class="tool"><span class="label">Per page</span><select id="perPage"><option>9</option><option>12</option><option>18</option><option>24</option></select></div>
      <div class="spacer"></div>
      <div class="tool"><button id="resetFilters" class="reset-filters" style="border: none; background: transparent; padding: 0; font: inherit; cursor: pointer;">Reset</button></div>
      <div class="tool" title="Toggle theme"><button id="themeToggle" class="switch" role="switch" aria-checked="false" aria-label="Toggle dark mode"><span class="knob"></span></button></div>
    </div>
  </header>

  <main class="container">
    <div class="results-info" id="resultsInfo"></div>
    <div id="grid" class="grid" aria-live="polite" aria-busy="true"></div>
    <nav class="pagination" id="pager" aria-label="Pagination"></nav>
  </main>

  <div id="modal" class="modal" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="dialog" role="document">
      <button class="close" id="modalClose" aria-label="Close">✕</button>
      <h3 id="mTitle" class="dialog-title"></h3>
      <div class="zoom-wrap" id="zoomWrap">
        <div class="zoom-canvas" id="zoomCanvas">
          <img id="mImg" class="zoom-img" alt="Product image"/>
        </div>
        <div class="zoom-controls"><button id="zoomOut">−</button><button id="zoomReset">100%</button><button id="zoomIn">+</button></div>
      </div>
      <div class="info" style="padding-top:.8rem">
        <div id="mModel" class="model"></div>
        <div class="tags" style="margin-top:.6rem"><span id="mRcp" class="tag rcp"></span><span id="mMember" class="tag member"></span></div>
        <div id="mRemark" style="margin-top:.6rem"></div>
      </div>
    </div>
  </div>

  <div id="notification" class="notification"></div>

  <script>
    // Improved utility functions
    const $ = (s, r = document) => r.querySelector(s);
    const $$ = (s, r = document) => Array.from(r.querySelectorAll(s));
    const toNum = (v) => Number(String(v ?? 0).toString().replace(/[^\d.]/g, "")) || 0;
    const fmtRM = (n) => toNum(n).toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0});
    const debounce = (fn, ms = 250) => {
      let t;
      return (...a) => {
        clearTimeout(t);
        t = setTimeout(() => fn(...a), ms);
      };
    };

    // State management
    let products = [], view = [], page = 1, perPage = Number(localStorage.getItem('perPage') || 9);
    let filters = JSON.parse(localStorage.getItem('filters') || '{}');

    // Theme management
    const root = document.documentElement;
    const themeBtn = $('#themeToggle');
    const savedTheme = localStorage.getItem('theme') || (matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
    root.setAttribute('data-theme', savedTheme);
    themeBtn.setAttribute('aria-checked', savedTheme === 'dark');
    themeBtn.addEventListener('click', () => {
      const next = root.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
      root.setAttribute('data-theme', next);
      localStorage.setItem('theme', next);
      themeBtn.setAttribute('aria-checked', next === 'dark');
    });

    // Mobile filters toggle
    const mobileFiltersBtn = $('.mobile-filters');
    const toolbar = $('.toolbar');
    mobileFiltersBtn.addEventListener('click', () => {
      const isExpanded = toolbar.parentElement.classList.toggle('filters-expanded');
      toolbar.parentElement.classList.toggle('filters-collapsed', !isExpanded);
      mobileFiltersBtn.setAttribute('aria-expanded', isExpanded);
    });

    // Improved skeleton loader with shimmer effect
    const grid = $('#grid');
    function makeSkeleton() {
      grid.innerHTML = '';
      for (let i = 0; i < 9; i++) {
        const sk = document.createElement('div');
        sk.className = 'card';
        sk.innerHTML = `
          <div class="brand-badge skeleton" style="width:70px;height:28px"></div>
          <div class="frame skeleton"></div>
          <div class="coin skeleton" style="height:52px;width:92%"></div>
          <div class="info">
            <div class="skeleton" style="width:80%;height:18px;margin:.3rem 0"></div>
            <div class="skeleton" style="width:60%;height:14px;margin:.3rem 0"></div>
            <div class="skeleton" style="width:75%;height:28px;margin:.8rem 0;border-radius:999px"></div>
          </div>
        `;
        grid.appendChild(sk);
      }
    }
    makeSkeleton();

    // Data loading with error handling and loading state
    function showNotification(message, type = 'success') {
      const notification = $('#notification');
      notification.textContent = message;
      notification.className = `notification ${type}`;
      notification.classList.add('show');
      
      setTimeout(() => {
        notification.classList.remove('show');
      }, 3000);
    }

    function loadData() {
      fetch('data.xlsx')
        .then(r => {
          if (!r.ok) throw new Error(`HTTP ${r.status}: ${r.statusText}`);
          return r.arrayBuffer();
        })
        .then(buf => {
          const wb = XLSX.read(buf, {type: 'array'});
          const ws = wb.Sheets[wb.SheetNames[0]];
          products = XLSX.utils.sheet_to_json(ws);
          initControls(products);
          applyFilters();
          showNotification(`${products.length} products loaded successfully`);
        })
        .catch(err => {
          console.error('Error loading data:', err);
          grid.innerHTML = `
            <div class="card" style="min-height:auto;padding:1rem;grid-column:1/-1;text-align:center">
              <strong style="color:var(--on-strong);background:var(--brand);padding:.2rem .4rem;border-radius:6px">Failed to load data.xlsx</strong>
              <p style="color:var(--muted)">Ensure the first sheet has: <code>FULL NAME, MODEL, BRAND, RCP, MEMBER, URL, REMARK</code>.</p>
              <button id="retryLoad" style="margin-top:1rem;padding:.5rem 1rem;background:var(--brand);color:white;border:none;border-radius:8px;cursor:pointer">Retry</button>
            </div>
          `;
          $('#retryLoad').addEventListener('click', loadData);
        });
    }
    loadData();

    // Improved controls initialization with filter persistence
    function initControls(list) {
      const set = new Set(list.map(x => x.BRAND).filter(Boolean));
      const brandSel = $('#brand');
      [...set].sort().forEach(b => {
        const o = document.createElement('option');
        o.value = o.textContent = b;
        brandSel.appendChild(o);
      });
      
      // Restore saved filters
      if (filters.q) $('#q').value = filters.q;
      if (filters.brand) $('#brand').value = filters.brand;
      if (filters.sort) $('#sort').value = filters.sort;
      if (filters.coinMin) $('#coinMin').value = filters.coinMin;
      if (filters.coinMax) $('#coinMax').value = filters.coinMax;
      
      $('#perPage').value = String(perPage);
      $('#perPage').addEventListener('change', () => {
        perPage = Number($('#perPage').value);
        localStorage.setItem('perPage', perPage);
        page = 1;
        render();
      });
      
      $('#q').addEventListener('input', debounce(applyFilters, 250));
      $('#brand').addEventListener('change', applyFilters);
      $('#sort').addEventListener('change', applyFilters);
      $('#coinMin').addEventListener('input', debounce(applyFilters, 200));
      $('#coinMax').addEventListener('input', debounce(applyFilters, 200));
      
      // Reset filters button
      $('#resetFilters').addEventListener('click', () => {
        $('#q').value = '';
        $('#brand').value = '';
        $('#sort').value = '';
        $('#coinMin').value = '';
        $('#coinMax').value = '';
        filters = {};
        localStorage.removeItem('filters');
        applyFilters();
      });
      
      const coins = list.map(p => toNum(p.MEMBER) * 100).filter(n => n > 0);
      if (coins.length) {
        $('#coinMin').placeholder = String(Math.min(...coins));
        $('#coinMax').placeholder = String(Math.max(...coins));
      }
    }

    // Enhanced filtering with results counter
    function applyFilters() {
      // Save filters
      filters = {
        q: $('#q').value.trim(),
        brand: $('#brand').value,
        sort: $('#sort').value,
        coinMin: $('#coinMin').value,
        coinMax: $('#coinMax').value
      };
      localStorage.setItem('filters', JSON.stringify(filters));
      
      const q = filters.q.toLowerCase();
      const brand = filters.brand;
      const sort = filters.sort;
      const cMin = toNum(filters.coinMin || 0);
      const cMax = toNum(filters.coinMax || 0);
      
      view = products.filter(p => {
        const name = String(p['FULL NAME'] || '').toLowerCase();
        const model = String(p['MODEL'] || '').toLowerCase();
        const okQ = !q || name.includes(q) || model.includes(q);
        const okB = !brand || p.BRAND === brand;
        const coin = toNum(p.MEMBER) * 100;
        const okMin = !cMin || coin >= cMin;
        const okMax = !cMax || coin <= cMax;
        return okQ && okB && okMin && okMax;
      });
      
      if (sort === 'price-asc') view.sort((a, b) => toNum(a.MEMBER) - toNum(b.MEMBER));
      else if (sort === 'price-desc') view.sort((a, b) => toNum(b.MEMBER) - toNum(a.MEMBER));
      else if (sort === 'az') view.sort((a, b) => String(a['FULL NAME'] || '').localeCompare(String(b['FULL NAME'] || '')));
      else if (sort === 'za') view.sort((a, b) => String(b['FULL NAME'] || '').localeCompare(String(a['FULL NAME'] || '')));
      
      page = 1;
      render();
    }

    // Enhanced rendering with smooth transitions
    function render() {
      grid.setAttribute('aria-busy', 'true');
      
      // Add fade-out effect before updating content
      const cards = $$('.card', grid);
      cards.forEach(card => {
        card.style.opacity = '0';
        setTimeout(() => {
          if (card.parentNode) card.parentNode.removeChild(card);
        }, 150);
      });
      
      setTimeout(() => {
        const start = (page - 1) * perPage, end = start + perPage;
        const data = view.slice(start, end);
        
        // Update results info
        const resultsInfo = $('#resultsInfo');
        if (view.length === 0) {
          resultsInfo.innerHTML = 'No products found matching your criteria.';
        } else {
          const showing = Math.min(end, view.length);
          resultsInfo.innerHTML = `Showing ${start + 1}-${showing} of ${view.length} products`;
        }
        
        if (!data.length) {
          grid.innerHTML = `<div class="card" style="min-height:auto;padding:1rem;grid-column:1/-1;text-align:center"><strong>No products found.</strong></div>`;
          $('#pager').innerHTML = '';
          grid.removeAttribute('aria-busy');
          return;
        }
        
        grid.innerHTML = '';
        for (const p of data) {
          const card = document.createElement('article');
          card.className = 'card';
          card.style.opacity = '0'; // Start invisible for fade-in
          
          const scoin = (toNum(p.MEMBER) * 100).toLocaleString();
          const rcp = fmtRM(p.RCP);
          const mem = fmtRM(p.MEMBER);
          
          card.innerHTML = `
            <div class="brand-badge">${p.BRAND || ''}</div>
            <div class="frame">
              <img alt="${(p['FULL NAME'] || 'Product').replace(/"/g, '&quot;')}" loading="lazy" decoding="async" 
                   onerror="this.src='data:image/svg+xml,<svg xmlns=\'http://www.w3.org/2000/svg\' width=\'240\' height=\'240\'><rect width=\'100%\' height=\'100%\' fill=\'%23ffffff\'/><text x=\'50%\' y=\'50%\' dominant-baseline=\'middle\' text-anchor=\'middle\' fill=\'%23999\' font-family=\'Arial\' font-size=\'14\'>No Image</text></svg>'"
                   src="${p.URL || ''}">
            </div>
            <div class="coin">
              <img src="SCOIN.png" alt="S-COIN">
              <span>${scoin} S‑COIN</span>
            </div>
            <div class="info">
              <div class="name">${p['FULL NAME'] || ''}</div>
              <div class="model">${p['MODEL'] ? `Model: ${p['MODEL']}` : 'Model: N/A'}</div>
              <div class="tags">
                <span class="tag rcp">RCP: RM${rcp}</span>
                <span class="tag member">Member: RM${mem}</span>
              </div>
              ${p.REMARK ? `<div class="remark">${p.REMARK}</div>` : ''}
            </div>
          `;
          
          card.addEventListener('click', () => openModal(p));
          grid.appendChild(card);
          
          // Fade in animation
          setTimeout(() => {
            card.style.opacity = '1';
          }, 50);
        }
        
        updatePagination();
        grid.removeAttribute('aria-busy');
      }, 150);
    }

    // Improved pagination
    function updatePagination() {
      const total = Math.ceil(view.length / perPage);
      const pager = $('#pager');
      
      if (total <= 1) {
        pager.innerHTML = '';
        return;
      }
      
      const mk = (t, dis, fn) => {
        const b = document.createElement('button');
        b.textContent = t;
        if (dis) b.disabled = true;
        b.addEventListener('click', fn);
        return b;
      };
      
      pager.innerHTML = '';
      pager.append(
        mk('First', page === 1, () => { page = 1; render(); }),
        mk('Prev', page === 1, () => { page = Math.max(1, page - 1); render(); }),
        (() => {
          const s = document.createElement('span');
          s.style.fontWeight = '900';
          s.style.minWidth = '9ch';
          s.style.textAlign = 'center';
          s.textContent = `Page ${page} / ${total}`;
          return s;
        })(),
        mk('Next', page === total, () => { page = Math.min(total, page + 1); render(); }),
        mk('Last', page === total, () => { page = total; render(); })
      );
    }

    // Enhanced modal with improved zoom/pan
    const modal = $('#modal'), modalClose = $('#modalClose');
    const wrap = $('#zoomWrap'), canvas = $('#zoomCanvas'), img = $('#mImg');
    const zin = $('#zoomIn'), zout = $('#zoomOut'), zreset = $('#zoomReset');
    let scale = 1, pos = {x: 0, y: 0}, isPan = false, start = {x: 0, y: 0};
    
    function applyTransform() {
      canvas.style.transform = `translate(${pos.x}px, ${pos.y}px) scale(${scale})`;
    }
    
    function openModal(p) {
      img.src = p.URL || '';
      $('#mTitle').textContent = p['FULL NAME'] || '';
      $('#mModel').textContent = `Model: ${p['MODEL'] || 'N/A'}`;
      $('#mRcp').textContent = `RCP: RM${fmtRM(p.RCP)}`;
      $('#mMember').textContent = `Member Price: RM${fmtRM(p.MEMBER)}`;
      $('#mRemark').innerHTML = p.REMARK ? `<span class="remark">${p.REMARK}</span>` : '';
      
      resetZoom();
      modal.classList.add('show');
      modal.setAttribute('aria-hidden', 'false');
      modalClose.focus();
      
      // Prevent body scroll when modal is open
      document.body.style.overflow = 'hidden';
    }
    
    function closeModal() {
      modal.classList.remove('show');
      modal.setAttribute('aria-hidden', 'true');
      document.body.style.overflow = ''; // Restore body scroll
    }
    
    modalClose.addEventListener('click', closeModal);
    modal.addEventListener('click', e => {
      if (e.target === modal) closeModal();
    });
    
    window.addEventListener('keydown', e => {
      if (e.key === 'Escape') closeModal();
    });
    
    function resetZoom() {
      scale = 1;
      pos = {x: 0, y: 0};
      applyTransform();
    }
    
    zin.addEventListener('click', () => {
      scale = Math.min(6, scale + 0.25);
      applyTransform();
    });
    
    zout.addEventListener('click', () => {
      scale = Math.max(0.4, scale - 0.25);
      applyTransform();
    });
    
    zreset.addEventListener('click', resetZoom);
    
    // Improved zoom with wheel
    wrap.addEventListener('wheel', e => {
      e.preventDefault();
      const d = e.deltaY < 0 ? 0.18 : -0.18;
      const ns = Math.min(6, Math.max(0.4, scale + d));
      const r = wrap.getBoundingClientRect();
      const cx = e.clientX - r.left - r.width / 2;
      const cy = e.clientY - r.top - r.height / 2;
      pos.x -= cx * (ns - scale);
      pos.y -= cy * (ns - scale);
      scale = ns;
      applyTransform();
    }, {passive: false});
    
    // Improved panning
    wrap.addEventListener('pointerdown', e => {
      isPan = true;
      start = {x: e.clientX - pos.x, y: e.clientY - pos.y};
      wrap.setPointerCapture(e.pointerId);
    });
    
    wrap.addEventListener('pointermove', e => {
      if (!isPan) return;
      pos.x = e.clientX - start.x;
      pos.y = e.clientY - start.y;
      applyTransform();
    });
    
    wrap.addEventListener('pointerup', () => { isPan = false; });
    wrap.addEventListener('pointerleave', () => { isPan = false; });
    
    // Touch gesture support for mobile
    let initialDistance = 0;
    wrap.addEventListener('touchstart', e => {
      if (e.touches.length === 2) {
        e.preventDefault();
        initialDistance = Math.hypot(
          e.touches[0].clientX - e.touches[1].clientX,
          e.touches[0].clientY - e.touches[1].clientY
        );
      }
    });
    
    wrap.addEventListener('touchmove', e => {
      if (e.touches.length === 2) {
        e.preventDefault();
        const currentDistance = Math.hypot(
          e.touches[0].clientX - e.touches[1].clientX,
          e.touches[0].clientY - e.touches[1].clientY
        );
        
        if (initialDistance > 0) {
          const zoomFactor = currentDistance / initialDistance;
          scale = Math.min(6, Math.max(0.4, scale * zoomFactor));
          initialDistance = currentDistance;
          applyTransform();
        }
      }
    });
    
    wrap.addEventListener('touchend', e => {
      if (e.touches.length < 2) {
        initialDistance = 0;
      }
    });
  </script>
</body>
</html>
